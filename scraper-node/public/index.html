<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä RuStore</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-area">
                <h1>–£–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä RuStore</h1>
            </div>
            <div class="controls">
                <div id="scan-indicator"
                    style="display: none; color: var(--accent-color); font-size: 0.8rem; font-weight: 600;">
                    <span class="pulse">‚óè</span> SCANNING APPBRAIN...
                </div>
                <button class="btn btn-danger" onclick="resetRuStore()">üîÑ Reset Checks</button>
                <button id="update-list-btn" class="btn btn-primary" onclick="updateAppList()">
                    UPDATE TOP 100
                </button>
            </div>
        </header>

        <div class="formula-block">
            <button class="formula-toggle" onclick="toggleFormula()">
                üìê –ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è Opportunity Score?
                <span class="formula-arrow" id="formula-arrow">‚ñº</span>
            </button>
            <div class="formula-content" id="formula-content">
                <div class="formula-main">
                    <strong>Score = round(100 √ó (0.30¬∑F1 + 0.25¬∑F2 + 0.25¬∑F3 + 0.10¬∑F4 + 0.10¬∑F5))</strong>
                </div>
                <div class="formula-factors">
                    <div class="formula-factor">
                        <span class="factor-weight">30%</span>
                        <div class="factor-info">
                            <span class="factor-name">üèüÔ∏è Competition Gap (F1)</span>
                            <span class="factor-desc">–ú–∞–ª–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ RuStore ‚Üí –≤—ã—Å–æ–∫–∏–π –±–∞–ª–ª.
                                <code>max(0, 1 ‚àí –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã / 20)</code></span>
                        </div>
                    </div>
                    <div class="formula-factor">
                        <span class="factor-weight">25%</span>
                        <div class="factor-info">
                            <span class="factor-name">‚≠ê Quality Gap (F2)</span>
                            <span class="factor-desc">–ù–∏–∑–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ ‚Üí –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è
                                –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. <code>max(0, 1 ‚àí (avgRating ‚àí 2) / 3)</code></span>
                        </div>
                    </div>
                    <div class="formula-factor">
                        <span class="factor-weight">25%</span>
                        <div class="factor-info">
                            <span class="factor-name">üìà Proven Demand (F3)</span>
                            <span class="factor-desc">–ë–æ–ª—å—à–µ —É—Å—Ç–∞–Ω–æ–≤–æ–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –≤ GP ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π —Å–ø—Ä–æ—Å.
                                <code>min(1, log‚ÇÅ‚ÇÄ(installs + 1) / 9)</code></span>
                        </div>
                    </div>
                    <div class="formula-factor">
                        <span class="factor-weight">10%</span>
                        <div class="factor-info">
                            <span class="factor-name">‚úÖ Validated Quality (F4)</span>
                            <span class="factor-desc">–í—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –≤ GP ‚Üí –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –∏–¥–µ—è.
                                <code>max(0, min(1, (gpRating ‚àí 2.5) / 2))</code></span>
                        </div>
                    </div>
                    <div class="formula-factor">
                        <span class="factor-weight">10%</span>
                        <div class="factor-info">
                            <span class="factor-name">üí§ Top Competitor Weakness (F5)</span>
                            <span class="factor-desc">–°–ª–∞–±—ã–π –ª—É—á—à–∏–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç ‚Üí –ª–µ–≥—á–µ –æ–±–æ–π—Ç–∏.
                                <code>max(0, 1 ‚àí (maxRating ‚àí 2) / 3)</code></span>
                        </div>
                    </div>
                </div>
                <div class="formula-legend">
                    <span class="legend-item"><span class="opp-dot opp-dot-high"></span> 65‚Äì100 ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è
                        –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</span>
                    <span class="legend-item"><span class="opp-dot opp-dot-medium"></span> 40‚Äì64 ‚Äî —Å—Ä–µ–¥–Ω—è—è
                        –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</span>
                    <span class="legend-item"><span class="opp-dot opp-dot-low"></span> 0‚Äì39 ‚Äî –Ω–∏–∑–∫–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</span>
                </div>
            </div>
        </div>

        <div class="tabs" id="tabs"></div>
        <div class="filters" id="filters"></div>

        <!-- ‚îÄ‚îÄ‚îÄ Flow 2: Idea Check Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div id="idea-check-panel" style="display:none;">

            <div class="idea-input-section">
                <h2 class="idea-section-title">üí° –ê–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π –∏–¥–µ–∏</h2>
                <p class="idea-section-subtitle">
                    –û–ø–∏—à–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å. Qwen –æ—Ü–µ–Ω–∏—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–¥–µ–∏,
                    –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä–∏–º –Ω–∞–ª–∏—á–∏–µ –∞–Ω–∞–ª–æ–≥–æ–≤ –≤ RuStore –∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º Opportunity Score.
                </p>
                <textarea id="idea-textarea" class="idea-textarea"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–æ—á—É —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å ‚Äî –±–µ–Ω–∑–∏–Ω, —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –¢–û. –° –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ –æ –ø–ª–∞–Ω–æ–≤–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏."
                    rows="4"></textarea>
                <div class="idea-input-controls">
                    <span id="idea-char-count" class="idea-char-count">0 / 1000</span>
                    <button id="idea-analyze-btn" class="btn btn-idea" onclick="checkIdea()">
                        <span class="btn-text">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ—é</span>
                        <div class="loader" style="display:none;"></div>
                    </button>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
            <div id="idea-result-container" style="display:none;"></div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ -->
            <div class="idea-history-section">
                <div class="idea-history-header">
                    <h3 class="idea-history-title">üìã –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫</h3>
                    <button class="btn-refresh-history" onclick="loadIdeaHistory()" title="–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">‚Üª</button>
                </div>
                <div id="idea-history-list">
                    <div class="empty-state" style="padding: 40px 0;">
                        <div class="empty-icon">üì≠</div>
                        <h3>–ï—â—ë –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫</h3>
                        <p>–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>App</th>
                        <th>Category</th>
                        <th>GP Rating</th>
                        <th>Installs</th>
                        <th>Recent</th>
                        <th>RuStore Check</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="app-table-body">
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">‚è≥</div>
                                <h3>Loading...</h3>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ Formula toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleFormula() {
            const content = document.getElementById('formula-content');
            const arrow = document.getElementById('formula-arrow');
            content.classList.toggle('open');
            arrow.textContent = content.classList.contains('open') ? '‚ñ≤' : '‚ñº';
        }

        // ‚îÄ‚îÄ‚îÄ State from URL params ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getParams() {
            const p = new URLSearchParams(window.location.search);
            return {
                tab: p.get('tab') || 'top_free',
                filter: p.get('filter') || 'all'
            };
        }

        function setParams(tab, filter) {
            const url = new URL(window.location);
            url.searchParams.set('tab', tab);
            url.searchParams.set('filter', filter);
            window.history.pushState({}, '', url);
        }

        let currentTab = getParams().tab;
        let currentFilter = getParams().filter;

        // ‚îÄ‚îÄ‚îÄ Switch between AppBrain table view and Idea Check panel ‚îÄ‚îÄ
        function applyTabView() {
            const isIdea = currentTab === 'idea_check';
            const ideaPanel = document.getElementById('idea-check-panel');
            const tableContainer = document.querySelector('.table-container');
            const filtersEl = document.getElementById('filters');
            const formulaBlock = document.querySelector('.formula-block');
            const updateBtn = document.getElementById('update-list-btn');

            if (isIdea) {
                ideaPanel.style.display = 'block';
                tableContainer.style.display = 'none';
                filtersEl.style.display = 'none';
                if (formulaBlock) formulaBlock.style.display = 'none';
                if (updateBtn) updateBtn.style.display = 'none';
                loadIdeaHistory();
            } else {
                ideaPanel.style.display = 'none';
                tableContainer.style.display = 'block';
                filtersEl.style.display = 'flex';
                if (formulaBlock) formulaBlock.style.display = 'block';
                if (updateBtn) updateBtn.style.display = 'inline-flex';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Render tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderTabs() {
            const tabs = [
                { key: 'top_free', label: 'üèÜ Top Free Overall' },
                { key: 'top_new_free', label: 'üÜï Top New Free Overall' },
                { key: 'idea_check', label: 'üí° Idea Check' }
            ];
            const container = document.getElementById('tabs');
            container.innerHTML = tabs.map(t =>
                `<a class="tab-link ${t.key === currentTab ? 'active' : ''} ${t.key === 'idea_check' ? 'tab-link-idea' : ''}" data-tab="${t.key}">${t.label}</a>`
            ).join('');

            container.querySelectorAll('.tab-link').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentTab = el.dataset.tab;
                    setParams(currentTab, currentFilter);
                    renderTabs();
                    renderFilters();
                    applyTabView();
                    if (currentTab !== 'idea_check') loadApps();
                });
            });
        }

        // ‚îÄ‚îÄ‚îÄ Render filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderFilters() {
            if (currentTab === 'idea_check') {
                document.getElementById('filters').innerHTML = '';
                return;
            }
            const filters = [
                { key: 'all', label: 'All' },
                { key: 'not_checked', label: 'Not Checked' },
                { key: 'checked', label: 'Checked' }
            ];
            const container = document.getElementById('filters');
            container.innerHTML = filters.map(f =>
                `<a class="filter-link ${f.key === currentFilter ? 'active' : ''}" data-filter="${f.key}">${f.label}</a>`
            ).join('');

            container.querySelectorAll('.filter-link').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentFilter = el.dataset.filter;
                    setParams(currentTab, currentFilter);
                    renderFilters();
                    loadApps();
                });
            });
        }

        // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function getRatingBadgeClass(rating) {
            if (rating >= 4.5) return 'badge-success';
            if (rating >= 3.5) return 'badge-warning';
            return 'badge-danger';
        }

        function getOpportunityClass(score) {
            if (score >= 65) return 'opp-high';
            if (score >= 40) return 'opp-medium';
            return 'opp-low';
        }

        function getOpportunityEmoji(score) {
            if (score >= 65) return 'üü¢';
            if (score >= 40) return 'üü°';
            return 'üî¥';
        }

        function getRatingColor(rating) {
            if (!rating) return 'var(--text-muted)';
            if (rating >= 4.5) return 'var(--success-color)';
            if (rating >= 3.5) return 'var(--warning-color)';
            return 'var(--danger-color)';
        }

        // ‚îÄ‚îÄ‚îÄ Load and render apps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadApps() {
            const tbody = document.getElementById('app-table-body');
            tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">‚è≥</div><h3>Loading...</h3></div></td></tr>`;

            try {
                const res = await fetch(`/api/apps?tab=${currentTab}&filter=${currentFilter}`);
                const data = await res.json();

                if (!res.ok) {
                    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><h3>Error</h3><p>${escapeHtml(data.error || 'Unknown error')}</p></div></td></tr>`;
                    return;
                }

                const apps = data.apps;

                if (!apps || apps.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üì≠</div><h3>No apps loaded</h3><p>Click UPDATE TOP 100 to start.</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = apps.map(app => renderAppRow(app)).join('');

            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">‚ùå</div><h3>Connection error</h3><p>${escapeHtml(e.message)}</p></div></td></tr>`;
            }
        }

        function renderAppRow(app) {
            const safeTitle = escapeHtml(app.title);
            const safeCategory = escapeHtml(app.category || '');
            const ratingClass = getRatingBadgeClass(app.gp_rating);

            let statusHtml;
            if (app.rustore_exists === 1) {
                statusHtml = `<button class="btn-report-toggle" onclick="toggleReport(${app.id})">üìä Report</button>`;
            } else {
                statusHtml = `<button class="btn btn-check" onclick="checkRuStore(${app.id}, this)">
                    <span class="btn-text">Check RS</span>
                    <div class="loader"></div>
                </button>`;
            }

            let scoreHtml;
            if (app.opportunity_score !== null && app.opportunity_score !== undefined) {
                const oppClass = getOpportunityClass(app.opportunity_score);
                const oppEmoji = getOpportunityEmoji(app.opportunity_score);
                scoreHtml = `<span class="opportunity-badge ${oppClass}">${oppEmoji} ${app.opportunity_score}/100</span>`;
            } else {
                scoreHtml = `<span style="color: var(--text-muted); opacity: 0.5;">‚Äî</span>`;
            }

            return `
                <tr id="app-row-${app.id}"
                    data-title="${safeTitle}"
                    data-gp-rating="${app.gp_rating || 0}"
                    data-category="${safeCategory}"
                    data-installs="${escapeHtml(app.installs || 'N/A')}">
                    <td class="rank-cell">${app.rank}</td>
                    <td class="app-cell">
                        <span class="app-title">${safeTitle}</span>
                        <div class="app-meta">
                            <a href="${escapeHtml(app.gp_url || '')}" target="_blank"
                                style="color: var(--accent-color); text-decoration: none;">AppBrain Context</a>
                        </div>
                    </td>
                    <td><span class="category-tag">${safeCategory}</span></td>
                    <td>
                        <div class="rating-badge ${ratingClass}">
                            ‚≠ê ${app.gp_rating || 0}
                        </div>
                    </td>
                    <td style="font-weight: 600; color: #f0f6fc;">${escapeHtml(app.installs || 'N/A')}</td>
                    <td><span style="color: var(--warning-color); font-weight: 500;">${escapeHtml(app.recent || 'N/A')}</span></td>
                    <td class="status-cell">${statusHtml}</td>
                    <td class="score-cell">${scoreHtml}</td>
                </tr>
                <tr class="report-row" id="report-row-${app.id}">
                    <td colspan="8" style="padding: 0 16px 16px 16px;">
                        <div id="report-panel-${app.id}"></div>
                    </td>
                </tr>`;
        }

        // ‚îÄ‚îÄ‚îÄ Update app list (scrape AppBrain) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function updateAppList() {
            const btn = document.getElementById('update-list-btn');
            const indicator = document.getElementById('scan-indicator');

            const tabLabel = currentTab === 'top_new_free' ? 'Top New Free' : 'Top Free';
            if (!confirm(`This will refresh the ${tabLabel} Top 100 list from AppBrain. Continue?`)) return;

            btn.disabled = true;
            indicator.style.display = 'block';

            try {
                const res = await fetch(`/api/update-list?tab=${currentTab}`, { method: 'POST' });
                const data = await res.json();
                if (res.ok) {
                    await loadApps();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Connection error: ' + e.message);
            } finally {
                btn.disabled = false;
                indicator.style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Reset RuStore checks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function resetRuStore() {
            if (!confirm('Reset all RuStore check results? This cannot be undone.')) return;

            try {
                const res = await fetch('/api/reset-rustore', { method: 'POST' });
                const data = await res.json();
                if (res.ok) {
                    await loadApps();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Connection error: ' + e.message);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Check RuStore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function checkRuStore(id, btnEl) {
            const row = document.getElementById(`app-row-${id}`);
            const title = row.dataset.title;
            const gpRating = parseFloat(row.dataset.gpRating) || 0;
            const category = row.dataset.category;
            const installs = row.dataset.installs || 'N/A';

            const btnText = btnEl.querySelector('.btn-text');
            const loader = btnEl.querySelector('.loader');

            btnEl.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';

            try {
                const res = await fetch(`/api/check/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, gp_rating: gpRating, category, installs })
                });

                const data = await res.json();

                if (data.success) {
                    const statusCell = row.querySelector('.status-cell');
                    const scoreCell = row.querySelector('.score-cell');
                    const report = data.report;
                    const oppScore = report.opportunityScore;

                    // Update status ‚Üí Report button
                    statusCell.innerHTML = `<button class="btn-report-toggle" onclick="toggleReport(${id})">üìä Report</button>`;

                    // Update score
                    if (oppScore !== null && oppScore !== undefined) {
                        const oppClass = getOpportunityClass(oppScore);
                        const oppEmoji = getOpportunityEmoji(oppScore);
                        scoreCell.innerHTML = `<span class="opportunity-badge ${oppClass}">${oppEmoji} ${oppScore}/100</span>`;
                    }

                    // Render and show report
                    renderReport(id, report);
                    row.classList.add('row-updated');
                } else {
                    alert('Check failed: ' + (data.error || 'Unknown error'));
                    btnEl.disabled = false;
                    btnText.style.display = 'block';
                    loader.style.display = 'none';
                }
            } catch (e) {
                alert('Error checking RuStore: ' + e.message);
                btnEl.disabled = false;
                btnText.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Report rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderReport(appId, report) {
            const reportRow = document.getElementById(`report-row-${appId}`);
            const reportPanel = document.getElementById(`report-panel-${appId}`);

            if (!report) return;

            let competitorsHtml = '';
            if (report.topCompetitors && report.topCompetitors.length > 0) {
                competitorsHtml = `
                    <div class="competitors-list">
                        <h4>üèÜ –¢–æ–ø-5 –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É</h4>
                        ${report.topCompetitors.map((c, i) => `
                            <div class="competitor-item">
                                <span class="competitor-rank">${i + 1}.</span>
                                <div class="competitor-info">
                                    <a href="${escapeHtml(c.url || '')}" target="_blank" class="competitor-name">${escapeHtml(c.name)}</a>
                                    <div class="competitor-dev">${escapeHtml(c.category || '')}</div>
                                </div>
                                <span class="competitor-rating" style="color: ${getRatingColor(c.rating)}">
                                    ${c.rating ? '‚≠ê ' + c.rating : '‚Äî'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                competitorsHtml = '<div class="no-results-msg">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –≤—ã–¥–∞—á–µ –†—É–°—Ç–æ—Ä–∞</div>';
            }

            const oppScore = report.opportunityScore;
            const oppClass = getOpportunityClass(oppScore);
            const oppEmoji = getOpportunityEmoji(oppScore);

            reportPanel.innerHTML = `
                <div class="report-panel">
                    <div class="report-header">
                        <h3>üîç RuStore Report: <a href="${escapeHtml(report.searchUrl || '')}" target="_blank" class="search-query-link">"${escapeHtml(report.searchQuery || '')}"</a></h3>
                        ${oppScore !== null && oppScore !== undefined ? `<span class="opportunity-badge ${oppClass}">${oppEmoji} Opportunity: ${oppScore}/100</span>` : ''}
                    </div>
                    <div class="report-stats">
                        <div class="stat-card">
                            <span class="stat-value">${report.competitorsCount}</span>
                            <span class="stat-label">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">${report.avgRating !== null && report.avgRating !== undefined ? '‚≠ê ' + report.avgRating : '‚Äî'}</span>
                            <span class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">${report.maxRating !== null && report.maxRating !== undefined ? '‚≠ê ' + report.maxRating : '‚Äî'}</span>
                            <span class="stat-label">–ú–∞–∫—Å. —Ä–µ–π—Ç–∏–Ω–≥</span>
                        </div>
                    </div>
                    ${competitorsHtml}
                </div>
            `;

            reportRow.classList.add('open');
        }

        async function toggleReport(id) {
            const reportRow = document.getElementById(`report-row-${id}`);
            const reportPanel = document.getElementById(`report-panel-${id}`);

            if (reportRow.classList.contains('open')) {
                reportRow.classList.remove('open');
                return;
            }

            if (reportPanel.innerHTML.trim() === '') {
                reportPanel.innerHTML = '<div style="padding: 20px; text-align: center;"><div class="loader" style="display: inline-block; border-top-color: var(--accent-color);"></div> Loading report...</div>';
                reportRow.classList.add('open');

                try {
                    const res = await fetch(`/api/report/${id}`);
                    const data = await res.json();
                    if (data.success) {
                        renderReport(id, data.report);
                    } else {
                        reportPanel.innerHTML = `<div class="no-results-msg">Error: ${escapeHtml(data.error || 'Unknown')}</div>`;
                    }
                } catch (e) {
                    reportPanel.innerHTML = `<div class="no-results-msg">Connection error: ${escapeHtml(e.message)}</div>`;
                }
            } else {
                reportRow.classList.add('open');
            }
        }

        // ‚îÄ‚îÄ‚îÄ Handle browser back/forward ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addEventListener('popstate', () => {
            const p = getParams();
            currentTab = p.tab;
            currentFilter = p.filter;
            renderTabs();
            renderFilters();
            applyTabView();
            if (currentTab !== 'idea_check') loadApps();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ‚îÄ Flow 2: Idea Check JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤ textarea
        document.getElementById('idea-textarea').addEventListener('input', function () {
            const len = this.value.length;
            document.getElementById('idea-char-count').textContent = `${len} / 1000`;
            if (len > 1000) this.value = this.value.slice(0, 1000);
        });

        // ‚îÄ‚îÄ‚îÄ –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–¥–µ—é –Ω–∞ –∞–Ω–∞–ª–∏–∑ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function checkIdea() {
            const textarea = document.getElementById('idea-textarea');
            const btn = document.getElementById('idea-analyze-btn');
            const btnText = btn.querySelector('.btn-text');
            const loader = btn.querySelector('.loader');
            const resultContainer = document.getElementById('idea-result-container');

            const description = textarea.value.trim();
            if (description.length < 10) {
                textarea.focus();
                textarea.style.borderColor = 'var(--danger-color)';
                setTimeout(() => textarea.style.borderColor = '', 2000);
                return;
            }

            btn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';
            resultContainer.style.display = 'none';

            try {
                const res = await fetch('/api/check-idea', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    resultContainer.style.display = 'block';
                    resultContainer.innerHTML = `<div class="idea-result-panel idea-result-error">
                        <div class="idea-verdict-header">‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</div>
                        <p style="color:var(--text-muted);margin-top:8px;">${escapeHtml(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}</p>
                    </div>`;
                    return;
                }

                resultContainer.style.display = 'block';
                resultContainer.innerHTML = renderIdeaReport(data);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
                loadIdeaHistory();

            } catch (e) {
                resultContainer.style.display = 'block';
                resultContainer.innerHTML = `<div class="idea-result-panel idea-result-error">
                    <div class="idea-verdict-header">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
                    <p style="color:var(--text-muted);margin-top:8px;">${escapeHtml(e.message)}</p>
                </div>`;
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                loader.style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–¥–µ–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderIdeaReport(data) {
            const ev = data.ideaEvaluation || {};
            const verdict = ev.verdict || 'unknown';

            const verdictConfig = {
                promising: { cls: 'verdict-promising', emoji: 'üü¢', label: '–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è –∏–¥–µ—è' },
                weak: { cls: 'verdict-weak', emoji: 'üî¥', label: '–°–ª–∞–±–∞—è –∏–¥–µ—è' },
                too_broad: { cls: 'verdict-broad', emoji: 'üü°', label: '–°–ª–∏—à–∫–æ–º —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç–æ' },
                unknown: { cls: 'verdict-broad', emoji: '‚ö™', label: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }
            };
            const vc = verdictConfig[verdict] || verdictConfig.unknown;

            // –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ RuStore (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª –∑–∞–ø—Ä–æ—Å)
            let ruStoreBlock = '';
            if (!data.skippedRuStore && data.searchUrl) {
                const score = data.opportunityScore;
                const oppClass = getOpportunityClass(score);
                const oppEmoji = getOpportunityEmoji(score);

                let competitorsHtml = '';
                if (data.topCompetitors && data.topCompetitors.length > 0) {
                    competitorsHtml = `<div class="competitors-list">
                        <h4>üèÜ –¢–æ–ø-${data.topCompetitors.length} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ RuStore</h4>
                        ${data.topCompetitors.map((c, i) => `
                            <div class="competitor-item">
                                <span class="competitor-rank">${i + 1}.</span>
                                <div class="competitor-info">
                                    <a href="${escapeHtml(c.url || '')}" target="_blank" class="competitor-name">${escapeHtml(c.name)}</a>
                                    <div class="competitor-dev">${escapeHtml(c.category || '')}</div>
                                </div>
                                <span class="competitor-rating" style="color:${getRatingColor(c.rating)}">
                                    ${c.rating ? '‚≠ê ' + c.rating : '‚Äî'}
                                </span>
                            </div>`).join('')}
                    </div>`;
                } else {
                    competitorsHtml = '<div class="no-results-msg">–ê–Ω–∞–ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ RuStore ‚Äî —Ä—ã–Ω–æ–∫ —Å–≤–æ–±–æ–¥–µ–Ω!</div>';
                }

                ruStoreBlock = `
                    <div class="idea-rustore-section">
                        <div class="report-header">
                            <h3>üîç RuStore: <a href="${escapeHtml(data.searchUrl)}" target="_blank" class="search-query-link">"${escapeHtml(data.searchQuery || '')}"</a></h3>
                            ${score !== null && score !== undefined ? `<span class="opportunity-badge ${oppClass}">${oppEmoji} Opportunity: ${score}/100</span>` : ''}
                        </div>
                        <div class="report-stats">
                            <div class="stat-card">
                                <span class="stat-value">${data.competitorsCount ?? '‚Äî'}</span>
                                <span class="stat-label">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value">${data.avgRating !== null && data.avgRating !== undefined ? '‚≠ê ' + data.avgRating : '‚Äî'}</span>
                                <span class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value">${data.maxRating !== null && data.maxRating !== undefined ? '‚≠ê ' + data.maxRating : '‚Äî'}</span>
                                <span class="stat-label">–ú–∞–∫—Å. —Ä–µ–π—Ç–∏–Ω–≥</span>
                            </div>
                        </div>
                        ${competitorsHtml}
                    </div>`;
            } else if (data.skippedRuStore) {
                ruStoreBlock = `<div class="idea-skip-notice">
                    ‚ö° –ü—Ä–æ–≤–µ—Ä–∫–∞ RuStore –ø—Ä–æ–ø—É—â–µ–Ω–∞ ‚Äî –∏–¥–µ—è –Ω–µ –ø—Ä–æ—à–ª–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä.
                </div>`;
            }

            // –ú–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ –æ—Ç Qwen
            const meta = [];
            if (ev.estimatedCategory) meta.push(`<span class="idea-meta-tag">üìÇ ${escapeHtml(ev.estimatedCategory)}</span>`);
            if (ev.estimatedGpRating) meta.push(`<span class="idea-meta-tag">‚≠ê GP ~${ev.estimatedGpRating}</span>`);
            if (ev.estimatedInstalls) meta.push(`<span class="idea-meta-tag">üì≤ ~${escapeHtml(ev.estimatedInstalls)}</span>`);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å–∞–π—Ç-–±–∞–Ω–Ω–µ—Ä –∫–æ–≥–¥–∞ –∏–¥–µ—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞, –Ω–æ —Å–∫–æ—Ä –∫—Ä–∞—Å–Ω—ã–π
            let insightBanner = '';
            if (verdict === 'promising' && data.opportunityScore !== null && data.opportunityScore !== undefined && data.opportunityScore < 40 && !data.skippedRuStore) {
                insightBanner = `<div class="idea-insight-banner">
                    üí° <strong>–ò–¥–µ—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞</strong> ‚Äî AI –æ—Ü–µ–Ω–∏–ª –µ—ë –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ. –ö—Ä–∞—Å–Ω—ã–π —Å–∫–æ—Ä –æ—Ç—Ä–∞–∂–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ RuStore, –Ω–æ <em>–Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç —Ü–µ–Ω–Ω–æ—Å—Ç—å –∏–¥–µ–∏</em>: –º–æ–∂–Ω–æ –≤–æ–π—Ç–∏ —Å –ª—É—á—à–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º.
                </div>`;
            }

            return `<div class="idea-result-panel">
                <div class="idea-verdict-header ${vc.cls}">
                    ${vc.emoji} ${vc.label}
                    ${data.opportunityScore !== null && data.opportunityScore !== undefined && !data.skippedRuStore
                    ? `<span class="opportunity-badge ${getOpportunityClass(data.opportunityScore)}" style="margin-left:auto;">${getOpportunityEmoji(data.opportunityScore)} ${data.opportunityScore}/100</span>`
                    : ''}
                </div>
                <div class="idea-reasoning">${escapeHtml(ev.reasoning || '')}</div>
                ${insightBanner}
                ${meta.length ? `<div class="idea-meta-tags">${meta.join('')}</div>` : ''}
                ${ruStoreBlock}
            </div>`;
        }

        // ‚îÄ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏–¥–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadIdeaHistory() {
            const historyEl = document.getElementById('idea-history-list');
            historyEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const res = await fetch('/api/idea-checks');
                const data = await res.json();

                if (!data.success || !data.checks || data.checks.length === 0) {
                    historyEl.innerHTML = `<div class="empty-state" style="padding:40px 0;">
                        <div class="empty-icon">üì≠</div>
                        <h3>–ï—â—ë –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫</h3>
                        <p>–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª</p>
                    </div>`;
                    return;
                }

                historyEl.innerHTML = data.checks.map(c => renderIdeaHistoryItem(c)).join('');

            } catch (e) {
                historyEl.innerHTML = `<div class="no-results-msg">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${escapeHtml(e.message)}</div>`;
            }
        }

        // ‚îÄ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderIdeaHistoryItem(check) {
            const verdictConfig = {
                promising: { cls: 'verdict-promising', emoji: 'üü¢' },
                weak: { cls: 'verdict-weak', emoji: 'üî¥' },
                too_broad: { cls: 'verdict-broad', emoji: 'üü°' }
            };
            const vc = verdictConfig[check.verdict] || { cls: 'verdict-broad', emoji: '‚ö™' };
            const score = check.opportunity_score;
            const date = new Date(check.created_at).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });

            return `<div class="idea-history-item" onclick="toggleIdeaHistoryReport(${check.id}, this)">
                <div class="idea-history-item-header">
                    <span class="idea-history-verdict ${vc.cls}">${vc.emoji}</span>
                    <span class="idea-history-desc">${escapeHtml(check.description.slice(0, 120))}${check.description.length > 120 ? '‚Ä¶' : ''}</span>
                    <div class="idea-history-meta">
                        ${score !== null && score !== undefined ? `<span class="opportunity-badge ${getOpportunityClass(score)}" style="font-size:0.75rem;padding:2px 8px;">${getOpportunityEmoji(score)} ${score}</span>` : ''}
                        <span class="idea-history-date">${date}</span>
                    </div>
                </div>
                <div class="idea-history-report" id="idea-history-report-${check.id}" style="display:none;"></div>
            </div>`;
        }

        // ‚îÄ‚îÄ‚îÄ Toggle –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function toggleIdeaHistoryReport(ideaId, itemEl) {
            const reportEl = document.getElementById(`idea-history-report-${ideaId}`);
            if (reportEl.style.display === 'block') {
                reportEl.style.display = 'none';
                return;
            }

            if (reportEl.innerHTML.trim() === '') {
                reportEl.style.display = 'block';
                reportEl.innerHTML = '<div style="padding:16px;text-align:center;"><div class="loader" style="display:inline-block;border-top-color:var(--accent-color);"></div> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    const res = await fetch(`/api/idea-report/${ideaId}`);
                    const data = await res.json();
                    if (data.success && data.report) {
                        const r = data.report;
                        // –°–æ–±–∏—Ä–∞–µ–º data-–æ–±—ä–µ–∫—Ç –≤ —Ñ–æ—Ä–º–∞—Ç renderIdeaReport
                        const payload = {
                            ideaEvaluation: {
                                verdict: r.verdict,
                                reasoning: r.reasoning,
                                estimatedCategory: r.estimatedCategory,
                                estimatedGpRating: r.estimatedGpRating,
                                estimatedInstalls: r.estimatedInstalls
                            },
                            searchQuery: r.searchQuery,
                            searchUrl: r.ruStoreReport?.searchUrl || null,
                            skippedRuStore: r.skippedRuStore,
                            competitorsCount: r.ruStoreReport?.competitorsCount ?? 0,
                            avgRating: r.ruStoreReport?.avgRating ?? null,
                            maxRating: r.ruStoreReport?.maxRating ?? null,
                            opportunityScore: r.opportunityScore,
                            topCompetitors: r.ruStoreReport?.topCompetitors || []
                        };
                        reportEl.innerHTML = renderIdeaReport(payload);
                    } else {
                        reportEl.innerHTML = `<div class="no-results-msg">–û—à–∏–±–∫–∞: ${escapeHtml(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}</div>`;
                    }
                } catch (e) {
                    reportEl.innerHTML = `<div class="no-results-msg">–û—à–∏–±–∫–∞: ${escapeHtml(e.message)}</div>`;
                }
            } else {
                reportEl.style.display = 'block';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        renderTabs();
        renderFilters();
        applyTabView();
        if (currentTab !== 'idea_check') loadApps();
    </script>
</body>

</html>